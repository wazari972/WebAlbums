#!/bin/sh
# Maintainer: Kevin Pouget <webalbums-archlinux@0x972.info>

pkgbase="WebAlbums"
pkgname=("webalbums-appserver-git" "webalbums-webapp-git"
         "webalbums-jfs-git" "webalbums-all-git")
pkgrel=0
pkgver=1
arch=('any')
url="https://github.com/wazari972/WebAlbums"
license=('GPL')
md5sums=() #generate with 'makepkg -g'
makedepends=('git' 'apache-ant' 'gcc' 'fuse' 'jre7-openjdk')
pkgdesc_all="Free webbased photo manager"

_depends_appserver=('jre7-openjdk')
_depends_webapp=('imagemagick' 'mariadb') #'webalbums-appserver'
_depends_jfs=() #'webalbums-webapp'
depends=("${_depends_appserver[@]}"
         "${_depends_webapp[@]}"
         "${_depends_jfs[@]}")

_gitroot=https://github.com/wazari972/WebAlbums
_gitname=webalbums-git
_gitbranch=develop
_localgit=/home/kevin/WebAlbums

_makefile=$_gitname/packaging/Makefile

__pkgver() {
    # get DATE here
  cd "$srcdir/$pkgname"
  ( set -o pipefail
    git describe --long --tags 2>/dev/null | sed 's/\([^-]*-g\)/r\1/;s/-/./g' ||
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
  )
}

build() {
    cd "$srcdir"
    msg "Connecting to git server... $pkgname"
    
    if [[ -d "$_gitname" ]]; then
        msg "Pulling from git origin repository ..."
        cd "$_gitname" #&& git pull origin
        msg "The local files are updated."
    else
        msg "Cloning git origin repository ..."
        git clone -b "$_gitbranch" "$_gitroot" "$_gitname"
    fi
    
    msg "Git checkout done (or server timeout)"
    msg "Starting build..."
    make -f $srcdir/$_makefile build_webapp  
    make -f $srcdir/$_makefile build_jfs  
    
    msg "Build done"
}

package() {
    msg "Preparing package $pkgname archive ..."
    make -f $srcdir/$_makefile BUILD_DIRNAME=$pkgdir $*
}

package_webalbums-appserver-git() {
    depends=$_depends_appserver
    pkgdesc="$pkgdesc_all -- Tomee Application Appserver"
    package prep_appserver
}

package_webalbums-webapp-git() {
    depends=$_depends_webapp
    pkgdesc="$pkgdesc_all -- Main application"
    optdepends=('ffmpeg: for video thumbnails',
                'totem: for video thumbnails')
    package conf_webapp conf_root_path conf_jfs
    make -f $srcdir/$_makefile BUILD_DIRNAME=$pkgdir EXEC_PREFIX=/ path_build_to_exec
}
package_webalbums-jfs-git() {
    depends=$_depends_jfs
    pkgdesc="$pkgdesc_all -- Java File-system"
   
    package prep_jfs
}

package_webalbums-all-git() {
    pkgdesc=$pkgdesc_all
    package all
}
