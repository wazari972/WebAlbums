<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
 "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
   <!-- See http://developer.yahoo.com/yui/grids/ for info on the grid layout -->
   <title>Local Timeline Example</title>
   <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
   <script type="text/javascript" src="static/scripts/lib/jquery/js/jquery.js"></script>

   <script src="static/scripts/lib/timeline_2.3.0/timeline_ajax/simile-ajax-api.js?bundle=true" type="text/javascript"></script>
   <script src="static/scripts/lib/timeline_2.3.0/timeline_js/timeline-api.js?bundle=true" type="text/javascript"></script>
   
   
   <style type="text/css">
        html  {background-color: #003366;}

        h1 {color: #834c24;}
        p {margin-top: .5em;}
        
        #timeline {
            height : 400px;
        }
        /*
        #albums img {
            max-height:  100px;
            max-width:  200px;
        }*/
   </style>

   <script  type="text/javascript">
       var timeline_data = {  // save as a global variable
            'dateTimeFormat': 'iso8601',
            'events' : []
        }
        var NB_LINES = 2;
        var tl;
        $(function() {
            $.get('Albums?special=SELECT', function(data) {
                xmlData = $(data)
                xmlData.find("album").each(function() {
                    timeline_data.events.push({
                        "start" : $(this).find("albmDate").text(),
                        "title" : $(this).find("name").text(),
                        "description" : $(this).find("description").text(),
                        "image" : "Miniature__"+$(this).find("picture").attr("id")+".png",
                        "link" : "Photo__"+$(this).attr("id")+"__"+$(this).find("name").text(),
                        "color": "#00AA00",
                        "albumid": $(this).attr("id")
                    })
                })
                
                if (timeline_data.events.length != 0) {
                    createTimeline(timeline_data)
                } else {
                    alert("No data found")
                }
            });
        })
        
        var minDisplayed = null;
        function oneDaySince(date) {
            if (minDisplayed == null)
                return true;
            
            return Math.abs(minDisplayed.getTime() - date.getTime()) > 1000*60*60*24*30;
        }
        
        function isGoingBack(date) {
            if (minDisplayed == null)
                return false
            
            return minDisplayed.getTime() > date.getTime()
        }
        
        function scroll() {
            var band = tl.getBand(0)
            var min = band.getMinVisibleDate()
            var max = band.getMaxVisibleDate()
            
            if (!oneDaySince(min))
                return
            
            var goingBack =  isGoingBack(min)
            
            minDisplayed = min;
            
            var evtSrc = band.getEventSource()
            
            var totalCount = evtSrc.getCount()
            
            var visibleCount = 0
            for (var i = 0; i < totalCount; i++) {
                var evt = evtSrc.getEvent("e"+(i+1))
                try {
                if (!evt)
                    continue
                } catch(e) {continue}
                var id = evt.getProperty("albumid")
                
                if (evt.getEarliestEnd() < min || evt.getLatestStart() > max) {
                    $("#album"+id).hide()
                } else {
                    visibleCount++
                    if ($("#album"+id).length != 0) {
                        $("#album"+id).show()
                    } else {
                        var img = new Image()
                        img.id = "album"+id
                        img.src = evt.getProperty("image")
                        img.title = evt.getProperty("title")
                        if (goingBack) {
                            $("#albums").prepend(img)
                        } else {
                            $("#albums").append(img)
                        }
                    }
                }
            }
            var width = (Math.floor(NB_LINES*100/visibleCount)) + "%"
            $("#albums img").css({"max-width" : width})
        }
        
        function createTimeline(tl_data) {
            var eventSource = new Timeline.DefaultEventSource();
            
            var theme = Timeline.ClassicTheme.create();
            
            var startParts = tl_data.events[tl_data.events.length-1].start.split("-")
            var stopParts = tl_data.events[0].start.split("-")
            
            theme.timeline_start = new Date(startParts[0], (startParts[1] - 1), startParts[2]);
            theme.timeline_stop  = new Date(stopParts[0], (stopParts[1] - 1), stopParts[2]);
            
            var bandInfos = [
                Timeline.createBandInfo({
                    width:          "90%",
                    intervalUnit:   Timeline.DateTime.MONTH, 
                    intervalPixels: 300,
                    eventSource:    eventSource,
                    date:           theme.timeline_stop,
                    theme:          theme,
                    layout:         'original'  // original, overview, detailed
                }),
                Timeline.createHotZoneBandInfo({
                    width:          "10%", 
                    intervalUnit:   Timeline.DateTime.YEAR, 
                    intervalPixels: 200,
                    eventSource:    eventSource,
                    date:           theme.timeline_stop, 
                    //timeZone:       -6,
                    overview:       true,
                    theme:          theme,
                    zones : []
                })
            ];
            bandInfos[1].syncWith = 0;
            bandInfos[1].highlight = true;
            
            // create the Timeline
            tl = Timeline.create(document.getElementById("timeline"), bandInfos, Timeline.HORIZONTAL);
            eventSource.loadJSON(tl_data, ".");
            tl.layout(); // display the Timeline
            
            tl.getBand(0).addOnScrollListener(scroll); 
            scroll()
        }
        
        var resizeTimerID = null;
        function onResize() {
            if (resizeTimerID == null) {
                resizeTimerID = window.setTimeout(function() {
                    resizeTimerID = null;
                    tl.layout();
                }, 500);
            }
        }
   </script>

    </head>
    <body>
        <div id='timeline'></div>
        <div id='albums'></div>
    </body>
</html>


